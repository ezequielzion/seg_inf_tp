<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <title>This is a title</title>
</head>

<body>
    <div style="display: flex; flex-direction: column;">
        <h1>Hola Rodo, acá vas a elegir el tipo de canary token (por favor no intentes hackear la página)</h1>
        <select id="tokenSelector">
            <option>pdf</option>
            <option>excel</option>
            <option>word</option>
            <option>epub</option>
            <option>mysql</option>
        </select>

        <div style="display: flex;">
            <span>Contenido del token: </span>
            <input id="tokenContent" />
        </div>

        <button onclick="generar()">Generame el token tiger</button>
    </div>
</body>
<script>
    function generar() {
        const select = document.getElementById("tokenSelector")
        const input = document.getElementById("tokenContent")
        fetch("/nuevoToken", {
            method: "post",
            body: JSON.stringify({ tipo: select.value, contenido: input.value }),
            headers: {
                "Content-Type": "application/json",
                // 'Content-Type': 'application/x-www-form-urlencoded',
            },
        }).then(resp => resp.status === 200 ? resp.blob() : Promise.reject('something went wrong'))
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                // the filename you want
                a.download = `canary-token.${getExt(select.value)}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(() => alert('oh no!'));
    }

    const evtSource = new EventSource("listen");
    evtSource.onmessage = (e) => {
        alert("se activó el token con el siguiente contenido: \n\n" + e.data)
    };

    function getExt(tipo) {
        switch (tipo) {
            case 'epub':
            case 'pdf':
                return tipo
                break;
            case 'word':
                return 'doc'//?
                break;
            case 'excel':
                return 'xlsx'
                break;
            case 'mysql':
                return 'txt'//?
                break;
            default:
                throw new Error('no hackees la pagina')
                break;
        }
    }
</script>

</html>